<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://tree.science/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://tree.science/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="isidentical" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="ast, python, ancestral chain, Abstract Syntax Trees, " />

<meta property="og:title" content="Using Ancestral Chain in AST "/>
<meta property="og:url" content="https://tree.science/using-ancestral-chains-in-ast.html" />
<meta property="og:description" content="Use cases for such chains, and a possible 30 LoC python implementation." />
<meta property="og:site_name" content="Tree Science" />
<meta property="og:article:author" content="isidentical" />
<meta property="og:article:published_time" content="2020-07-06T23:53:00+03:00" />
<meta name="twitter:title" content="Using Ancestral Chain in AST ">
<meta name="twitter:description" content="Use cases for such chains, and a possible 30 LoC python implementation.">

        <title>Using Ancestral Chain in AST  Â· Tree Science
</title>
        <link href="https://tree.science/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tree Science - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-171614891-1', 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://tree.science/"><span class=site-name>Tree Science</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://tree.science
                                    >Home</a>
                                </li>
                                <li ><a href="https://tree.science/categories.html">Categories</a></li>
                                <li ><a href="https://tree.science/tags.html">Tags</a></li>
                                <li ><a href="https://tree.science/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://tree.science/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://tree.science/using-ancestral-chains-in-ast.html">
                Using Ancestral Chain in AST
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Tree-like data is a common consumption target of applications that are empowered
by visitor pattern. A couple of use cases of this pattern includes code generators
(a.k.a compilers), static code analysis tools (linters), and code formatters. Code
generators take advantage of working with heterogeneous data. On the other side,
linters make use of working with-in a state to process previously learned information
about that codebase.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Emitter</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_module</span><span class="p">()</span> <span class="k">as</span> <span class="n">module</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module</span>

    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

        <span class="n">opcode</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Instruction</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPERATION_</span><span class="si">{</span><span class="n">opcode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Instruction</span><span class="p">(</span><span class="s2">&quot;LITERAL&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
</code></pre></div>

<p>As seen in the upper example, implementing a simple AST to some imaginary
bytecode compiler isn't hard at all. It only requires a visitor class and
implementation of how an individual node should act when seen. This kind of
<code>Visitor</code>s actually take the whole responsibility of visiting the tree, in
a way that can be used recursively. </p>
<p>What I mean by "recursive" is that in common languages, fields on certain nodes
contain heterogeneous data (sums). For example, rhs or lhs of a binary operation
can be a <code>Name</code>, a <code>Call</code>, or simply another binary operation. Instead of having
certain conditions for all of them, you can simply pass it to the <code>Visitor</code> and it
will do the job of finding the right place to emit code for that node.</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">visit_constant</span><span class="p">(</span><span class="n">Generator</span><span class="o">*</span> <span class="n">gen</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">EMIT</span><span class="p">(</span><span class="s">&quot;LITERAL&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">Constant</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">visit_binop</span><span class="p">(</span><span class="n">Generator</span><span class="o">*</span> <span class="n">gen</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">visit_expression</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">BinOp</span><span class="p">.</span><span class="n">left</span><span class="p">));</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">visit_expression</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">BinOp</span><span class="p">.</span><span class="n">right</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">EMIT</span><span class="p">(</span><span class="n">_operator_name</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">BinOp</span><span class="p">.</span><span class="n">operator</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">visit_expression</span><span class="p">(</span><span class="n">Generator</span><span class="o">*</span> <span class="n">gen</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">Name_kind</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">visit_name</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
        <span class="k">case</span> <span class="nl">BinOp_kind</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">visit_binop</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
        <span class="k">case</span> <span class="nl">Constant_kind</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">visit_constant</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>In the example above, the <code>visit_binop</code> function doesn't need to know what is
the type of lhs / rhs. It just knows it is an expression and passes it to a top-level 
<code>visit_expression</code> function which then handles the rest. Okay, we are good up to know, 
but what about some context dependant actions. </p>
<h2>Context Dependent Actions</h2>
<p>So, imagine you have a language that has certain features, but using two different
esoteric functionality together should be forbidden. Grammars are not suitable for
such actions because while the construction, no one knows what context you are in
or who are your neighbors (you can actually record about it, but it would be a big mess).
Since you are already using the visitor pattern to compile the AST, you can think that while
compiling one of that features, you can peek around and find if it is good to use
or not. For this example, I'll forbid using control flow elements inside of a <code>finally</code>.</p>
<p>Let's see what we should handle</p>
<div class="highlight"><pre><span></span><code>        <span class="n">For</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Store</span><span class="p">()),</span>
            <span class="nb">iter</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                <span class="n">Try</span><span class="p">(</span>
                    <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">Pass</span><span class="p">()],</span>
                    <span class="n">handlers</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">orelse</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">finalbody</span><span class="o">=</span><span class="p">[</span><span class="n">Continue</span><span class="p">()],</span> <span class="c1"># &lt;=======</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">orelse</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">type_comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>

<p>What we are looking for a <code>Continue</code> (or <code>Break()</code> etc.) inside of a finally inside of a
for loop. Let's try to draft an implemention of it.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ast</span>

<span class="k">class</span> <span class="nc">Compiler</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inside_for</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">jumper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;FOR_LOOP&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit_body</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">jumper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inside_for</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></div>

<p>Okay, from the initial point, we got ourselves a "state" (<code>self.inside_for</code>), it is no big
deal. The only downside we can think of, for now, is the code looks kinda messy. We can probably
write a context manager to set an instance variable, but I don't think that would be a pythonic idea.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">visit_Try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_guard</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">as</span> <span class="n">guard</span><span class="p">:</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inside_finally</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inside_finally</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_for</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_finally</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
</code></pre></div>

<p>It started to have more states (<code>self.inside_finally</code>), more and more. Guess we can have a context manager 
to at least reduce this hand managing burden, but it won't solve the problem of thousands of different
states that you may require or not. While the codebase grows, some of them will become obsolete, useless; 
and no one might just notice it. And the actual problem is that, this check is wrong, for cases like the code
below.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">continue</span>
</code></pre></div>

<p>This should successfully run because the <code>continue</code> belongs a different <code>for</code> loop, and that has nothing
to do with the upper <code>try/finally</code> clause. We can probably solve this with more and more states but I won't
advise it because it would make the code more confusing, complex and awful.</p>
<p>As the title may suggest, the solution to this problem might be, the ancestral chains. It is some kind of
backtracking to the original tree node from the child.</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; tree = ast.parse(&quot;2+2&quot;, mode=&quot;eval&quot;)
&gt;&gt;&gt; lhs = tree.body.left
&gt;&gt;&gt; lhs
&lt;ast.Constant object at 0x7f39270f9af0&gt;
&gt;&gt;&gt; lhs.parent
&lt;ast.BinOp object at 0x7f39270f97d0&gt;
&gt;&gt;&gt; lhs.parent.parent
&lt;ast.Expression object at 0x7f39270f9730&gt;
</code></pre></div>

<p>Having such a chain attached to node objects would allow us to search in that context and check if we have
the right conditions to raise an error. </p>
<h3>Implementation</h3>
<p>Let's implement a simple <code>relate(tree: AST) -&gt; None</code> function
that would take the tree, and <code>parent</code> field to all nodes by traversing it.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">relate</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p>The first thing is setting the parent of root node. It is important because it will signal consumers to
where they should stop.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
</code></pre></div>

<p><code>ast.walk</code> will walk in every node and leaf, which they all be parents (leaves might not, but that won't matter
since the function below doesn't return anything on that case)</p>
<div class="highlight"><pre><span></span><code>        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</code></pre></div>

<p><code>iter_child_nodes</code> will yield all the <em>first-level</em> child nodes that belong to the given node. And then we can safely
set the parent. It might be a cool idea to use <code>weakref.ref</code> here, but I don't think the parents will go away
while the children are still living. </p>
<p>Also, it might be good to have a flatten function that will iterate all <code>parents</code>, something like this</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">while</span> <span class="n">parent</span> <span class="o">:=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">parent</span>
</code></pre></div>

<p>This way we can do some kind of search among the parents</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_parents</span><span class="p">(</span><span class="n">lhs</span><span class="p">))</span>
<span class="p">(</span><span class="o">&lt;</span><span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f46b7e3d190</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ast</span><span class="o">.</span><span class="n">Expression</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f46b7ed6c80</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expression</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">lhs</span><span class="p">)))</span>
<span class="kc">True</span>
</code></pre></div>

<p>This was it, all we need is that searching for parents. If we want to repeat the <code>Compiler</code> example with the same
the bug we had, it would be as simple and as pythonic as this;</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AncestorChain</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">Compiler</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="n">FORBIDDEN_SET</span> <span class="o">=</span> <span class="n">AncestorChain</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Try</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">FORIBDDEN_SET</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
</code></pre></div>

<p>It is this simple, no states at all. Although we made the code simple, we want to also solve the bug. One thing
that came to my mind for such cases is a utility function that returns the first occurrence of a type in that
chain. This will help us to find the first occurrence of the try clause and then we can check its parent for the given
for.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">first_occurrence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">ancestors</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">class</span> <span class="nc">Compiler</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">FORIBDDEN_SET</span><span class="p">:</span>
            <span class="n">for_clause</span> <span class="o">=</span> <span class="n">first_occurrence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">)</span>
            <span class="n">try_clause</span> <span class="o">=</span> <span class="n">first_occurrence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Try</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_parented_by</span><span class="p">(</span><span class="n">try_clause</span><span class="p">,</span> <span class="n">for_clause</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
</code></pre></div>

<p>What it does is that it finds the first try/finally and the first for clause and then
it checks that if that <code>continue</code>'s bound for is also the parent of that <code>try/finally</code>
clause, if so, it raises the value error, but cases like this;</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">continue</span>
</code></pre></div>

<p>it will be silenced. </p>
<p>So, instead of having millions of states, we solved the problem with 3 lines of extra code to the compiler.
Having an advantage of working in a dynamic language, will certainly helped the simpler implementation
of this ancestral chains, but I dont think there will be a decent difference on languages like C about
the implementation's look. And by the way, thanks for reading. If you want to contact to me, please check
out the social section in the footer, or mail me directly from <code>isidentical [at] tree.science</code>.</p>
<h2>Appendix 1: Full Code</h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ast</span>

<span class="k">def</span> <span class="nf">relate</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">tree</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

<span class="k">def</span> <span class="nf">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">while</span> <span class="n">parent</span> <span class="o">:=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">parent</span>

<span class="k">class</span> <span class="nc">AncestorChain</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">first_occurrence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">ancestors</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">is_parented_by</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">ancestors</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>


             
 
                <p id="post-share-links">
    Share on:
      <a href="https://twitter.com/intent/tweet?text=Using%20Ancestral%20Chain%20in%20AST&url=https%3A//tree.science/using-ancestral-chains-in-ast.html&hashtags=ast,python,ancestral-chain" target="_blank" rel="nofollow noopener noreferrer" title="Share on Twitter">Twitter</a>
 â       <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//tree.science/using-ancestral-chains-in-ast.html" target="_blank" rel="nofollow noopener noreferrer" title="Share on Facebook">Facebook</a>
 â       <a href="mailto:?subject=Using%20Ancestral%20Chain%20in%20AST&amp;body=https%3A//tree.science/using-ancestral-chains-in-ast.html" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>

            
            







            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">Â« <a href="https://tree.science/transitional-asdl.html" title="Previous: A few thoughts on the Zephyr&#39;s ASDL">A few thoughts on the Zephyr's ASDL</a></li>
                <li class="next-article"><a href="https://tree.science/lazy-lexers.html" title="Next: Lazy Lexers">Lazy Lexers</a> Â»</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-07-06T23:53:00+03:00">Pzt 06 Temmuz 2020</time>
            <h4>Category</h4>
            <a class="category-link" href="https://tree.science/categories.html#abstract-syntax-trees-ref">Abstract Syntax Trees</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://tree.science/tags.html#ancestral-chain-ref">ancestral chain
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://tree.science/tags.html#ast-ref">ast
                    <span class="superscript">3</span>
</a></li>
                <li><a href="https://tree.science/tags.html#python-ref">python
                    <span class="superscript">2</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/isidentical" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://github.com/isidentical" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        Content licensed under <a rel="license nofollow noopener noreferrer"
    href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
    Creative Commons Attribution 4.0 International License</a>.
    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Python/Pelican</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://tree.science/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>